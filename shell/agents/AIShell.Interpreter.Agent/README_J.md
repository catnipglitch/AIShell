# インタープリターエージェント

![インタープリターエージェントのデモを示すGIF][01]

## 説明

このエージェントは、コード関連のタスクを完了することに特化しています。
ユーザーのタスクを受け取り、計画を立て、コードを生成し、実行し、
エラーがあれば自己修正しながら、タスクが完了するまで計画の次のステップに進みます。
現在はPowerShellまたはPythonコードの生成と実行のみをサポートしています。

## 目次

- [使用方法][02]
- [前提条件][03]
- [設定][04]
- [アーキテクチャ][05]
- [既知の制限][06]

## 使用方法

1. 自然言語でタスクを入力すると、エージェントはタスクを完了するためのコードを生成します。
   英語での使用のみテストしていますが、他の言語でも機能する可能性があります。
2. 生成されたコードを実行するには、「y」と入力してEnterキーを押すか、単にEnterキーを押します（プロンプトはデフォルトで「y」）。
   設定ファイルでは自動実行を設定でき、ユーザーの確認なしにコードを実行します。
3. あとはエージェントが作業を行うのを見守るだけです。

## 前提条件

- PythonとPowerShell 7をインストールし、`PATH`環境変数に追加されていることを確認してください。
- 設定ファイルでAIサービスを設定する必要があります
  - OpenAIの場合、**モデル名**と**APIキー**が必要です。ドキュメント: [OpenAIモデル][10], [OpenAI APIキー][09]。
  - Azure OpenAIサービスの場合、**エンドポイント**、**デプロイメント名**、**モデル名**、**APIキー**が必要です。ドキュメント: [Azure OpenAIへのアクセス][07], [Azure OpenAIデプロイメントの作成][08]。

## 設定

エージェントを設定するには、`/agent config interpreter`を実行してデフォルトのエディタで設定ファイルを開き、
次の例に基づいてファイルを更新します。

```jsonc
{
  // Azure OpenAIサービスを使用する場合:
  // - `Endpoint`をAzure OpenAIサービスのエンドポイントに設定します。
  //   またはゲートウェイとしてAzure API Managementサービスを使用している場合は、そのエンドポイントに設定します。
  // - `Deployment`をAzure OpenAIサービスのデプロイメント名に設定します。
  // - `ModelName`をデプロイメントに使用されているモデルの名前（例: "gpt-4-0613"）に設定します。
  // - `Key`をAzure OpenAIサービスのアクセスキーに設定します。
  //   またはゲートウェイとしてAzure API Managementサービスを使用している場合は、そのキーに設定します。
  "Endpoint": "<Azure OpenAIエンドポイントを挿入>",
  "Deployment": "<デプロイメント名を挿入>",
  "ModelName": "<モデル名を挿入>",
  "Key": "<キーを挿入>",
  "AutoExecution": false, // 'true'でエージェントがコードを自動的に実行できるようにします。'false'でコードを実行する前に毎回プロンプトを表示します。
  "DisplayErrors": true   // 'true'でコード実行時のエラーを表示します。'false'で冗長さを減らすためにエラーを非表示にします。

  // 公開OpenAIサービスを使用する場合:
  // - `Endpoint`と`Deployment`キーは無視します。
  // - `ModelName`を使用するモデルの名前（例: "gpt-4o"）に設定します。
  // - `Key`をOpenAIアクセストークンに設定します。
  // 上記を次のように置き換えてください:
  /*
  "ModelName": "<モデル名を挿入>",
  "Key": "<キーを挿入>",
  "AutoExecution": false,
  "DisplayErrors": true
  */
}
```

## アーキテクチャ

このエージェントのアーキテクチャは以下の図に示されています。

1. エージェントは`interpreter.agent.json`ファイルを使用して初期化されます。
2. モデルタイプ（関数呼び出しまたはテキストベース）は設定に基づいて決定されます。
3. `TaskCompletionChat`がプログラムのメインループで、ユーザークエリが処理されます。
   - AIレスポンスに関数呼び出し/コードが含まれていない場合、メインプログラムループは終了します。
   - AIレスポンスに関数呼び出し/コードが含まれている場合、ユーザーの承認を得てコードが実行されます。
4. コード出力が表示され、収集され、AIに返されます。
5. コードの実行時にエラーが検出された場合、エージェントはそれらを修正し、コードを再実行しようとします。
6. タスクが完了するか、さらに情報が必要になるまでメインループが続きます。

<img src="./assets/Interpreter-Agent-Architecture.png" alt="Interpreter-Agent" width="500"/>

### 実行フロー

このエージェントの実行フローは以下の図に示されています。

<img src="./assets/InterpreterAgentFlowChart.png" alt="Interpreter-Agent" width="500"/>

## 既知の制限

- AI生成コードはまだ不正確なコードとレスポンスを生成する可能性があります。
- コード結果を検証する出力がない場合、エージェントはコード結果に関する幻覚を生じる可能性があります。
- チャット履歴はモデルごとにgitトークン制限に制限されます。
  チャットが長すぎる場合、エージェントは最も古い結果のコンテキストを失います。
- エージェントは同時タスクを処理できません。

<!-- リンク参照 -->
[01]: ./assets/InterpreterAgentDemoSpedUp.gif
[02]: #使用方法
[03]: #前提条件
[04]: #設定
[05]: #アーキテクチャ
[06]: #既知の制限
[07]: https://aka.ms/oai/access?azure-portal=true
[08]: https://learn.microsoft.com/azure/ai-services/openai/how-to/create-resource?pivots=web-portal
[09]: https://platform.openai.com/api-keys
[10]: https://platform.openai.com/docs/models